<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Prometheus - Harvest</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Harvest</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">What is Harvest?</a>
                            </li>
                            <li class="navitem">
                                <a href="../quickstart/" class="nav-link">Quickstart</a>
                            </li>
                            <li class="navitem">
                                <a href="../install/" class="nav-link">Installation</a>
                            </li>
                            <li class="navitem">
                                <a href="../system-requirements/" class="nav-link">System Requirements</a>
                            </li>
                            <li class="navitem">
                                <a href="../upgrade/" class="nav-link">Upgrade</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Prepare Monitored Clusters <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../prepare-cdot-clusters/" class="dropdown-item">ONTAP cDOT</a>
</li>
                                    
<li>
    <a href="../prepare-7mode-clusters/" class="dropdown-item">ONTAP 7mode</a>
</li>
                                    
<li>
    <a href="../prepare-storagegrid-clusters/" class="dropdown-item">StorageGRID</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../configure-harvest-basic/" class="nav-link">Configure Harvest (basic)</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Configure Exporters <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">Prometheus</a>
</li>
                                    
<li>
    <a href="../influxdb-exporter/" class="dropdown-item">InfluxDB</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../configure-grafana/" class="nav-link">Configure Grafana</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Configure Collectors <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../configure-zapi/" class="dropdown-item">ZAPI</a>
</li>
                                    
<li>
    <a href="../configure-rest/" class="dropdown-item">REST</a>
</li>
                                    
<li>
    <a href="../configure-ems/" class="dropdown-item">EMS</a>
</li>
                                    
<li>
    <a href="../configure-storagegrid/" class="dropdown-item">StorageGRID</a>
</li>
                                    
<li>
    <a href="../configure-unix/" class="dropdown-item">Unix</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../configure-templates/" class="nav-link">Templates</a>
                            </li>
                            <li class="navitem">
                                <a href="../dashboards/" class="nav-link">Dashboards</a>
                            </li>
                            <li class="navitem">
                                <a href="../manage-harvest/" class="nav-link">Manage Harvest Pollers</a>
                            </li>
                            <li class="navitem">
                                <a href="../configure-harvest-advanced/" class="nav-link">Configure Harvest (advanced)</a>
                            </li>
                            <li class="navitem">
                                <a href="../troubleshooting/" class="nav-link">Troubleshoot</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../resources/templates-and-metrics/" class="dropdown-item">Templates And Metrics</a>
</li>
                                    
<li>
    <a href="../resources/matrix/" class="dropdown-item">Matrix</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../license/" class="dropdown-item">License</a>
</li>
                                    
<li>
    <a href="../release-notes/" class="dropdown-item">Release Notes</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../configure-harvest-basic/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../influxdb-exporter/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/NetApp/harvest" class="nav-link">NetApp/harvest</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#prometheus-exporter" class="nav-link">Prometheus Exporter</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#overview" class="nav-link">Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#parameters" class="nav-link">Parameters</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#configure-prometheus-to-scrape-harvest-pollers" class="nav-link">Configure Prometheus to scrape Harvest pollers</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#prometheus-alerts" class="nav-link">Prometheus Alerts</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#alertmanager" class="nav-link">Alertmanager</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#reference" class="nav-link">Reference</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="prometheus-exporter">Prometheus Exporter<a class="headerlink" href="#prometheus-exporter" title="Permanent link">&para;</a></h1>
<details class="note" open="open">
<summary>Prometheus Install</summary>
<p>The information below describes how to setup Harvest's Prometheus exporter. 
If you need help installing or setting up Prometheus, check 
out <a href="https://prometheus.io/docs/prometheus/latest/getting_started/">their documention</a>.</p>
</details>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The Prometheus exporter is responsible for:</p>
<ul>
<li>formatting metrics into the Prometheus <a href="https://prometheus.io/docs/instrumenting/exposition_formats/">line protocol</a></li>
<li>creating a web-endpoint on <code>http://&lt;ADDR&gt;:&lt;PORT&gt;/metrics</code> for Prometheus to scrape</li>
</ul>
<p>A web end-point is required because Prometheus scrapes Harvest by polling that end-point.</p>
<p>In addition to the <code>/metrics</code> end-point, the Prometheus exporter also serves an overview of all metrics and collectors
available on its root address <code>http://&lt;ADDR&gt;:&lt;PORT&gt;/</code>.</p>
<p>Because Prometheus polls Harvest, don't forget
to <a href="#configure-prometheus-to-scrape-harvest-pollers">update your Prometheus configuration</a> and tell Prometheus how to
scrape each poller.</p>
<p>There are two ways to configure the Prometheus exporter: using a <code>port range</code> or individual <code>port</code>s.</p>
<p>The <code>port range</code> is more flexible and should be used when you want multiple pollers all exporting to the same instance
of Prometheus. Both options are explained below.</p>
<h2 id="parameters">Parameters<a class="headerlink" href="#parameters" title="Permanent link">&para;</a></h2>
<p>All parameters of the exporter are defined in the <code>Exporters</code> section of <code>harvest.yml</code>.</p>
<p>An overview of all parameters:</p>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
<th>default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>port_range</code></td>
<td>int-int (range), overrides <code>port</code> if specified</td>
<td>lower port to upper port (inclusive) of the HTTP end-point to create when a poller specifies this exporter. Starting at lower port, each free port will be tried sequentially up to the upper port.</td>
<td></td>
</tr>
<tr>
<td><code>port</code></td>
<td>int, required if port_range is not specified</td>
<td>port of the HTTP end-point</td>
<td></td>
</tr>
<tr>
<td><code>local_http_addr</code></td>
<td>string, optional</td>
<td>address of the HTTP server Harvest starts for Prometheus to scrape:<br />use <code>localhost</code> to serve only on the local machine<br />use <code>0.0.0.0</code> (default) if Prometheus is scrapping from another machine</td>
<td><code>0.0.0.0</code></td>
</tr>
<tr>
<td><code>global_prefix</code></td>
<td>string, optional</td>
<td>add a prefix to all metrics (e.g. <code>netapp_</code>)</td>
<td></td>
</tr>
<tr>
<td><code>allow_addrs</code></td>
<td>list of strings, optional</td>
<td>allow access only if host matches any of the provided addresses</td>
<td></td>
</tr>
<tr>
<td><code>allow_addrs_regex</code></td>
<td>list of strings, optional</td>
<td>allow access only if host address matches at least one of the regular expressions</td>
<td></td>
</tr>
<tr>
<td><code>cache_max_keep</code></td>
<td>string (Go duration format), optional</td>
<td>maximum amount of time metrics are cached (in case Prometheus does not timely collect the metrics)</td>
<td><code>300s</code></td>
</tr>
<tr>
<td><code>add_meta_tags</code></td>
<td>bool, optional</td>
<td>add <code>HELP</code> and <code>TYPE</code> <a href="https://prometheus.io/docs/instrumenting/exposition_formats/#comments-help-text-and-type-information">metatags</a> to metrics (currently no useful information, but required by some tools)</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>sort_labels</code></td>
<td>bool, optional</td>
<td>sort metric labels before exporting. Some <a href="https://github.com/NetApp/harvest/issues/756">open-metrics scrapers report</a> stale metrics when labels are not sorted.</td>
<td><code>false</code></td>
</tr>
</tbody>
</table>
<p>A few examples:</p>
<h4 id="port_range">port_range<a class="headerlink" href="#port_range" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">Exporters</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">prom-prod</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">exporter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prometheus</span><span class="w"></span>
<span class="w">    </span><span class="nt">port_range</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2000-2030</span><span class="w"></span>
<span class="nt">Pollers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">cluster-01</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">exporters</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prom-prod</span><span class="w"></span>
<span class="w">  </span><span class="nt">cluster-02</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">exporters</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prom-prod</span><span class="w"></span>
<span class="w">  </span><span class="nt">cluster-03</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">exporters</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prom-prod</span><span class="w"></span>
<span class="w">  </span><span class="c1"># ... more</span><span class="w"></span>
<span class="w">  </span><span class="nt">cluster-16</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">exporters</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prom-prod</span><span class="w"></span>
</code></pre></div>
<p>Sixteen pollers will collect metrics from 16 clusters and make those metrics available to a single instance of
Prometheus named <code>prom-prod</code>. Sixteen web end-points will be created on the first 16 available free ports between 2000
and 2030 (inclusive).</p>
<p>After staring the pollers in the example above, running <code>bin/harvest status</code> shows the following. Note that ports 2000
and 2003 were not available so the next free port in the range was selected. If no free port can be found an error will
be logged.</p>
<div class="highlight"><pre><span></span><code>Datacenter   Poller       PID     PromPort  Status              
++++++++++++ ++++++++++++ +++++++ +++++++++ ++++++++++++++++++++
DC-01        cluster-01   2339    2001      running         
DC-01        cluster-02   2343    2002      running         
DC-01        cluster-03   2351    2004      running         
...
DC-01        cluster-14   2405    2015      running         
DC-01        cluster-15   2502    2016      running         
DC-01        cluster-16   2514    2017      running         
</code></pre></div>
<h4 id="allow_addrs">allow_addrs<a class="headerlink" href="#allow_addrs" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">Exporters</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">my_prom</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">allow_addrs</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.102</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.103</span><span class="w"></span>
</code></pre></div>
<p>will only allow access from exactly these two addresses.</p>
<h4 id="allow_addrs_regex">allow_addrs_regex<a class="headerlink" href="#allow_addrs_regex" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">Exporters</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">my_prom</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">allow_addrs_regex</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="err">`</span><span class="l l-Scalar l-Scalar-Plain">^192.168.0.\d+$`</span><span class="w"></span>
</code></pre></div>
<p>will only allow access from the IP4 range <code>192.168.0.0</code>-<code>192.168.0.255</code>.</p>
<h2 id="configure-prometheus-to-scrape-harvest-pollers">Configure Prometheus to scrape Harvest pollers<a class="headerlink" href="#configure-prometheus-to-scrape-harvest-pollers" title="Permanent link">&para;</a></h2>
<p>There are two ways to tell Prometheus how to scrape Harvest: using HTTP service discovery (SD) or listing each poller
individually.</p>
<p>HTTP service discovery is the more flexible of the two. It is also less error-prone, and easier to manage. Combined with
the port_range configuration described above, SD is the least effort to configure Prometheus and the easiest way to keep
both Harvest and Prometheus in sync.</p>
<p><strong>NOTE</strong> HTTP service discovery does not work with Docker yet. With Docker, you will need to list each poller
individually or if possible, use the <a href="https://github.com/NetApp/harvest/tree/main/docker">Docker Compose</a> workflow that
uses file service discovery to achieve a similar ease-of-use as HTTP service discovery.</p>
<p>See the <a href="#prometheus-http-service-discovery-and-port-range">example</a> below for how to use HTTP SD and port_range
together.</p>
<h3 id="prometheus-http-service-discovery">Prometheus HTTP Service Discovery<a class="headerlink" href="#prometheus-http-service-discovery" title="Permanent link">&para;</a></h3>
<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#http_sd_config">HTTP service discovery</a> was
introduced in Prometheus version 2.28.0. Make sure you're using that version or later.</p>
<p>The way service discovery works is:</p>
<ul>
<li>shortly after a poller starts up, it registers with the SD node (if one exists)</li>
<li>the poller sends a heartbeat to the SD node, by default every 45s.</li>
<li>if a poller fails to send a heartbeat, the SD node removes the poller from the list of active targets after a minute</li>
<li>the SD end-point is reachable via SCHEMA://<listen>/api/v1/sd</li>
</ul>
<p>To use HTTP service discovery you need to:</p>
<ol>
<li>tell <a href="#enable-http-service-discovery-in-harvest">Harvest to start the HTTP service discovery process</a></li>
<li>tell <a href="#enable-http-service-discovery-in-prometheus">Prometheus to use the HTTP service discovery endpoint</a></li>
</ol>
<h4 id="enable-http-service-discovery-in-harvest">Enable HTTP service discovery in Harvest<a class="headerlink" href="#enable-http-service-discovery-in-harvest" title="Permanent link">&para;</a></h4>
<p>Add the following to your <code>harvest.yml</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">Admin</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">httpsd</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">:8887</span><span class="w"></span>
</code></pre></div>
<p>This tells Harvest to create an HTTP service discovery end-point on interface <code>0.0.0.0:8887</code>. If you want to only listen
on localhost, use <code>127.0.0.1:&lt;port&gt;</code> instead. See <a href="https://pkg.go.dev/net#Dial">net.Dial</a> for details on the supported
listen formats.</p>
<p>Start the SD process by running <code>bin/harvest admin start</code>. Once it is started, you can curl the end-point for the list
of running Harvest pollers.</p>
<div class="highlight"><pre><span></span><code>curl -s &#39;http://localhost:8887/api/v1/sd&#39; | jq .
[
  {
    &quot;targets&quot;: [
      &quot;10.0.1.55:12990&quot;,
      &quot;10.0.1.55:15037&quot;,
      &quot;127.0.0.1:15511&quot;,
      &quot;127.0.0.1:15008&quot;,
      &quot;127.0.0.1:15191&quot;,
      &quot;10.0.1.55:15343&quot;
    ]
  }
]
</code></pre></div>
<h4 id="harvest-http-service-discovery-options">Harvest HTTP Service Discovery options<a class="headerlink" href="#harvest-http-service-discovery-options" title="Permanent link">&para;</a></h4>
<p>HTTP service discovery (SD) is configured in the <code>Admin &gt; httpsd</code> section of your <code>harvest.yml</code>.</p>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
<th>default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>listen</code></td>
<td><strong>required</strong></td>
<td>Interface and port to listen on, use localhost:PORT or :PORT for all interfaces</td>
<td></td>
</tr>
<tr>
<td><code>auth_basic</code></td>
<td>optional</td>
<td>If present, enables basic authentication on <code>/api/v1/sd</code> end-point</td>
<td></td>
</tr>
<tr>
<td>auth_basic <code>username</code>, <code>password</code></td>
<td><strong>required</strong> child of <code>auth_basic</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>tls</code></td>
<td>optional</td>
<td>If present, enables TLS transport. If running in a container, see <a href="https://github.com/NetApp/harvest/issues/672#issuecomment-1036338589">note</a></td>
<td></td>
</tr>
<tr>
<td>tls <code>cert_file</code>, <code>key_file</code></td>
<td><strong>required</strong> child of <code>tls</code></td>
<td>Relative or absolute path to TLS certificate and key file. TLS 1.3 certificates required.<br />FIPS complaint P-256 TLS 1.3 certificates can be created with <code>bin/harvest admin tls create server</code></td>
<td></td>
</tr>
<tr>
<td><code>ssl_cert</code>, <code>ssl_key</code></td>
<td>optional if <code>auth_style</code> is <code>certificate_auth</code></td>
<td>Absolute paths to SSL (client) certificate and key used to authenticate with the target system.<br /><br />If not provided, the poller will look for <code>&lt;hostname&gt;.key</code> and <code>&lt;hostname&gt;.pem</code> in <code>$HARVEST_HOME/cert/</code>.<br/><br/>To create certificates for ONTAP systems, see <a href="../prepare-cdot-clusters/#using-certificate-authentication">using certificate authentication</a></td>
<td></td>
</tr>
<tr>
<td><code>heart_beat</code></td>
<td>optional, <a href="https://pkg.go.dev/time#ParseDuration">Go Duration format</a></td>
<td>How frequently each poller sends a heartbeat message to the SD node</td>
<td>45s</td>
</tr>
<tr>
<td><code>expire_after</code></td>
<td>optional, <a href="https://pkg.go.dev/time#ParseDuration">Go Duration format</a></td>
<td>If a poller fails to send a heartbeat, the SD node removes the poller after this duration</td>
<td>1m</td>
</tr>
</tbody>
</table>
<h4 id="enable-http-service-discovery-in-prometheus">Enable HTTP service discovery in Prometheus<a class="headerlink" href="#enable-http-service-discovery-in-prometheus" title="Permanent link">&para;</a></h4>
<p>Edit your <code>prometheus.yml</code> and add the following section</p>
<p><code>$ vim /etc/prometheus/prometheus.yml</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">harvest</span><span class="w"></span>
<span class="w">    </span><span class="nt">http_sd_configs</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost:8887/api/v1/sd</span><span class="w"></span>
</code></pre></div>
<p>Harvest and Prometheus both support basic authentication for HTTP SD end-points. To enable basic auth, add the following
to your Harvest config.</p>
<div class="highlight"><pre><span></span><code><span class="nt">Admin</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">httpsd</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">:8887</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Basic auth protects GETs and publishes</span><span class="w"></span>
<span class="w">    </span><span class="nt">auth_basic</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span><span class="w"></span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span><span class="w"></span>
</code></pre></div>
<p>Don't forget to also update your Prometheus config with the
matching <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#http_sd_config">basic_auth</a>
credentials.</p>
<h3 id="prometheus-http-service-discovery-and-port-range">Prometheus HTTP Service Discovery and Port Range<a class="headerlink" href="#prometheus-http-service-discovery-and-port-range" title="Permanent link">&para;</a></h3>
<p>HTTP SD combined with Harvest's <code>port_range</code> feature leads to significantly less configuration in your <code>harvest.yml</code>.
For example, if your clusters all export to the same Prometheus instance, you can refactor the per-poller exporter into
a single exporter shared by all clusters in <code>Defaults</code> as shown below:</p>
<p>Notice that none of the pollers specify an exporter. Instead, all the pollers share the single exporter
named <code>prometheus-r</code> listed in <code>Defaults</code>. <code>prometheus-r</code> is the only exporter defined and as specified will manage up
to 1,000 Harvest Prometheus exporters.</p>
<p>If you add or remove more clusters in the <code>Pollers</code> section, you do not have to change Prometheus since it dynamically
pulls the targets from the Harvest admin node.</p>
<div class="highlight"><pre><span></span><code><span class="nt">Admin</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">httpsd</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">:8887</span><span class="w"></span>

<span class="nt">Exporters</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">prometheus-r</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">exporter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prometheus</span><span class="w"></span>
<span class="w">    </span><span class="nt">port_range</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">13000-13999</span><span class="w"></span>

<span class="nt">Defaults</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">collectors</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Zapi</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ZapiPerf</span><span class="w"></span>
<span class="w">  </span><span class="nt">use_insecure_tls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">  </span><span class="nt">auth_style</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span><span class="w"></span>
<span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span><span class="w"></span>
<span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pass</span><span class="w"></span>
<span class="w">  </span><span class="nt">exporters</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prometheus-r</span><span class="w"></span>

<span class="nt">Pollers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">umeng_aff300</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">meg</span><span class="w"></span>
<span class="w">    </span><span class="nt">addr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.193.48.11</span><span class="w"></span>

<span class="w">  </span><span class="nt">F2240-127-26</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">meg</span><span class="w"></span>
<span class="w">    </span><span class="nt">addr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.193.6.61</span><span class="w"></span>

<span class="w">  </span><span class="c1"># ... add more clusters</span><span class="w"></span>
</code></pre></div>
<h3 id="static-scrape-targets">Static Scrape Targets<a class="headerlink" href="#static-scrape-targets" title="Permanent link">&para;</a></h3>
<p>If we define four prometheus exporters at ports: 12990, 12991, 14567, and 14568 you need to add four sections to
your <code>prometheus.yml</code>.</p>
<div class="highlight"><pre><span></span><code>$ vim /etc/prometheus/prometheus.yml
</code></pre></div>
<p>Scroll down to near the end of file and add the following lines:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;harvest&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60s</span><span class="w"></span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;localhost:12990&#39;</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;localhost:12991&#39;</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;localhost:14567&#39;</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;localhost:14568&#39;</span><span class="w"></span>
</code></pre></div>
<p><strong>NOTE</strong> If Prometheus is not on the same machine as Harvest, then replace <code>localhost</code> with the IP address of your
Harvest machine. Also note the scrape interval above is set to 60s. That matches the polling frequency of the default
Harvest collectors. If you change the polling frequency of a Harvest collector to a lower value, you should also change
the scrape interval.</p>
<h1 id="prometheus-alerts">Prometheus Alerts<a class="headerlink" href="#prometheus-alerts" title="Permanent link">&para;</a></h1>
<p>Prometheus includes out-of-the-box support for simple alerting. Alert rules are configured in your <code>prometheus.yml</code>
file. Setup and details can be found in the Prometheus
guide on <a href="https://prometheus.io/docs/practices/alerting/">alerting</a>.</p>
<p>Harvest also includes <a href="https://github.com/NetApp/harvest/blob/main/docker/prometheus/ems_alert_rules.yml">ems alerts</a>
and <a href="https://github.com/NetApp/harvest/blob/main/docker/prometheus/alert_rules.yml">sample alerts</a> for reference.
Refer <a href="https://github.com/NetApp/harvest/blob/main/cmd/collectors/ems/README.md">EMS Collector</a> for more details about
EMS events.</p>
<h2 id="alertmanager">Alertmanager<a class="headerlink" href="#alertmanager" title="Permanent link">&para;</a></h2>
<p>Prometheus's builtin alerts are good for simple workflows. They do a nice job telling you what's happening at the
moment.
If you need a richer solution that includes summarization, notification, advanced delivery, deduplication, etc.
checkout <a href="https://prometheus.io/docs/alerting/latest/alertmanager/">Alertmanager</a>.</p>
<h2 id="reference">Reference<a class="headerlink" href="#reference" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/">Prometheus Alerting</a></li>
<li><a href="https://prometheus.io/docs/alerting/latest/alertmanager/">Alertmanager</a></li>
<li><a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/AlertmanagerNotificationMetrics">Alertmanager's notification metrics</a></li>
<li><a href="https://github.com/cloudflare/pint">Prometheus Linter</a></li>
<li><a href="https://github.com/samber/awesome-prometheus-alerts">Collection of example Prometheus Alerts</a></li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; NetApp</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
