<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>EMS - Harvest</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Harvest</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">What is Harvest?</a>
                            </li>
                            <li class="navitem">
                                <a href="../quickstart/" class="nav-link">Quickstart</a>
                            </li>
                            <li class="navitem">
                                <a href="../install/" class="nav-link">Installation</a>
                            </li>
                            <li class="navitem">
                                <a href="../system-requirements/" class="nav-link">System Requirements</a>
                            </li>
                            <li class="navitem">
                                <a href="../upgrade/" class="nav-link">Upgrade</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Prepare Monitored Clusters <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../prepare-cdot-clusters/" class="dropdown-item">ONTAP cDOT</a>
</li>
                                    
<li>
    <a href="../prepare-7mode-clusters/" class="dropdown-item">ONTAP 7mode</a>
</li>
                                    
<li>
    <a href="../prepare-storagegrid-clusters/" class="dropdown-item">StorageGRID</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../configure-harvest-basic/" class="nav-link">Configure Harvest (basic)</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Configure Exporters <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../prometheus-exporter/" class="dropdown-item">Prometheus</a>
</li>
                                    
<li>
    <a href="../influxdb-exporter/" class="dropdown-item">InfluxDB</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../configure-grafana/" class="nav-link">Configure Grafana</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Configure Collectors <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../configure-zapi/" class="dropdown-item">ZAPI</a>
</li>
                                    
<li>
    <a href="../configure-rest/" class="dropdown-item">REST</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">EMS</a>
</li>
                                    
<li>
    <a href="../configure-storagegrid/" class="dropdown-item">StorageGRID</a>
</li>
                                    
<li>
    <a href="../configure-unix/" class="dropdown-item">Unix</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../configure-templates/" class="nav-link">Templates</a>
                            </li>
                            <li class="navitem">
                                <a href="../dashboards/" class="nav-link">Dashboards</a>
                            </li>
                            <li class="navitem">
                                <a href="../manage-harvest/" class="nav-link">Manage Harvest Pollers</a>
                            </li>
                            <li class="navitem">
                                <a href="../configure-harvest-advanced/" class="nav-link">Configure Harvest (advanced)</a>
                            </li>
                            <li class="navitem">
                                <a href="../troubleshooting/" class="nav-link">Troubleshoot</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../resources/templates-and-metrics/" class="dropdown-item">Templates And Metrics</a>
</li>
                                    
<li>
    <a href="../resources/matrix/" class="dropdown-item">Matrix</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../license/" class="dropdown-item">License</a>
</li>
                                    
<li>
    <a href="../release-notes/" class="dropdown-item">Release Notes</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../configure-rest/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../configure-storagegrid/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/NetApp/harvest" class="nav-link">NetApp/harvest</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#ems-collector" class="nav-link">EMS collector</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#ems-prometheus-alerts" class="nav-link">Ems Prometheus Alerts</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="ems-collector">EMS collector<a class="headerlink" href="#ems-collector" title="Permanent link">&para;</a></h2>
<p>The <code>EMS collector</code>
collects <a href="https://mysupport.netapp.com/documentation/productlibrary/index.html?productID=62286">ONTAP event management system</a> (
EMS) events via the ONTAP REST API.</p>
<p>This collector uses a YAML template file to define which events to collect, export, and what labels to attach to each
metric. This means you can collect new EMS events or attach new labels by editing
the <a href="https://github.com/NetApp/harvest/blob/main/conf/ems/default.yaml">default template</a> file or by <a href="../configure-templates/#how-to-extend-a-restrestperfems-collectors-existing-object-template">extending existing
templates</a>.</p>
<p>The <a href="https://github.com/NetApp/harvest/blob/main/conf/ems/default.yaml">default template</a> file contains 60+ EMS events.</p>
<h3 id="supported-ontap-systems">Supported ONTAP Systems<a class="headerlink" href="#supported-ontap-systems" title="Permanent link">&para;</a></h3>
<p>Any cDOT ONTAP system using 9.6 or higher.</p>
<h3 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">&para;</a></h3>
<p>It is recommended to create a read-only user on the ONTAP system.
See <a href="../prepare-cdot-clusters/">prepare an ONTAP cDOT cluster</a> for details.</p>
<h3 id="metrics">Metrics<a class="headerlink" href="#metrics" title="Permanent link">&para;</a></h3>
<p>This collector collects EMS events from ONTAP and for each received EMS event, creates new metrics prefixed
with <code>ems_events</code>.</p>
<p>Harvest supports two types of ONTAP EMS events:</p>
<ol>
<li><strong>Normal EMS events</strong></li>
</ol>
<p>Single shot events. When ONTAP detects a problem, an event is raised.
When the issue is addressed, ONTAP does <strong>not</strong> raise another event reflecting that the problem was resolved.</p>
<ol>
<li><strong>Bookend EMS events</strong></li>
</ol>
<p>ONTAP creates bookend events in matching pairs.
ONTAP creates an event when an issue is detected and another paired event when the event is resolved.
Typically, these events share a common set of properties.</p>
<h3 id="collector-configuration">Collector Configuration<a class="headerlink" href="#collector-configuration" title="Permanent link">&para;</a></h3>
<p>The parameters of the collector are distributed across three files:</p>
<ul>
<li><a href="../configure-harvest-basic/#pollers">Harvest configuration file</a> (default: <code>harvest.yml</code>)</li>
<li><a href="#ems-collector-configuration-file">EMS collector configuration</a> file (default: <code>conf/ems/default.yaml</code>)</li>
<li><a href="#ems-template-file">EMS template file</a> (located in <code>conf/ems/9.6.0/ems.yaml</code>)</li>
</ul>
<p>Except for <code>addr</code>, <code>datacenter</code>, and <code>auth_style</code>, all other parameters of the EMS collector can be defined
in either of these three files.
Parameters defined in the lower-level files, override parameters in the higher-level file.
This allows you to configure each EMS event individually, or use the same parameters for all events.</p>
<h4 id="ems-collector-configuration-file">EMS Collector Configuration File<a class="headerlink" href="#ems-collector-configuration-file" title="Permanent link">&para;</a></h4>
<p>This configuration file contains the parameters that are used to configure the EMS collector.
These parameters can be defined in your <code>harvest.yml</code> or <code>conf/ems/default.yaml</code> file.</p>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
<th>default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>client_timeout</code></td>
<td>Go duration</td>
<td>how long to wait for server responses</td>
<td>1m</td>
</tr>
<tr>
<td><code>schedule</code></td>
<td>list, required</td>
<td>the polling frequency of the collector/object. Should include exactly the following two elements in the order specified:</td>
<td></td>
</tr>
<tr>
<td>- <code>instance</code></td>
<td>Go duration</td>
<td>polling frequency for updating the instance cache (example value: <code>24h</code> = <code>1440m</code>)</td>
<td></td>
</tr>
<tr>
<td>- <code>data</code></td>
<td>Go duration</td>
<td>polling frequency for updating the data cache (example value: <code>3m</code>)<br /><br /><strong>Note</strong> Harvest allows defining poll intervals on sub-second level (e.g. <code>1ms</code>), however keep in mind the following:<br /><ul><li>API response of an ONTAP system can take several seconds, so the collector is likely to enter failed state if the poll interval is less than <code>client_timeout</code>.</li><li>Small poll intervals will create significant workload on the ONTAP system.</li></ul></td>
<td></td>
</tr>
</tbody>
</table>
<p>The EMS configuration file should contain the following section mapping the <code>Ems</code> object to the corresponding template
file.</p>
<div class="highlight"><pre><span></span><code><span class="nt">objects</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">Ems</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ems.yaml</span><span class="w"></span>
</code></pre></div>
<p>Even though the EMS mapping shown above references a single file named <code>ems.yaml</code>,
there may be multiple versions of that file across subdirectories named after ONTAP releases.
See <a href="https://github.com/NetApp/harvest/tree/main/conf/zapiperf/cdot">cDOT</a> for examples.</p>
<p>At runtime, the EMS collector will select the appropriate object configuration file that most closely matches the
targeted ONTAP system.</p>
<h4 id="ems-template-file">EMS Template File<a class="headerlink" href="#ems-template-file" title="Permanent link">&para;</a></h4>
<p>The EMS template file should contain the following parameters:</p>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
<th>default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>display name of the collector. this matches the named defined in your <code>conf/ems/default.yaml</code> file</td>
<td>EMS</td>
</tr>
<tr>
<td><code>object</code></td>
<td>string</td>
<td>short name of the object, used to prefix metrics</td>
<td>ems</td>
</tr>
<tr>
<td><code>query</code></td>
<td>string</td>
<td>REST API endpoint used to query EMS events</td>
<td><code>api/support/ems/events</code></td>
</tr>
<tr>
<td><code>exports</code></td>
<td>list</td>
<td>list of default labels attached to each exported metric</td>
<td></td>
</tr>
<tr>
<td><code>events</code></td>
<td>list</td>
<td>list of EMS events to collect. See <a href="#event-parameters">Event Parameters</a></td>
<td></td>
</tr>
</tbody>
</table>
<h5 id="event-parameters">Event Parameters<a class="headerlink" href="#event-parameters" title="Permanent link">&para;</a></h5>
<p>This section defines the list of EMS events you want to collect, which properties to export, what labels to attach, and
how to handle bookend pairs.
The EMS event template parameters are explained below along with an example for reference.</p>
<ul>
<li><code>name</code> is the ONTAP EMS event name. (collect ONTAP EMS events with the name of <code>LUN.offline</code>)</li>
<li><code>matches</code> list of name-value pairs used to further filter ONTAP events.
  Some EMS events include arguments and these name-value pairs provide a way to filter on those arguments.
  (Only collect ONTAP EMS events where <code>volume_name</code> has the value <code>abc_vol</code>)</li>
<li><code>exports</code> list of EMS event parameters to export. These exported parameters are attached as labels to each matching
  EMS event.<ul>
<li>labels that are prefixed with <code>^^</code> use that parameter to
  define <a href="../resources/templates-and-metrics/#harvest-object-template">instance uniqueness</a>.</li>
</ul>
</li>
<li><code>resolve_when_ems</code> (applicable to bookend events only). Lists the resolving event that pairs with the issuing event<ul>
<li><code>name</code> is the ONTAP EMS event name of the resolving EMS event (<code>LUN.online</code>).
  When the resolving event is received, the issuing EMS event will be resolved. In this example, Harvest will raise
  an event when it finds the ONTAP EMS event named <code>LUN.offline</code> and that event will be resolved when the EMS event
  named <code>LUN.online</code> is received.</li>
<li><code>resolve_after</code> (optional, Go duration, default = 28 days) resolve the issuing EMS after the specified duration
  has elapsed (<code>672h</code> = <code>28d</code>).
  If the bookend pair is not received within the <code>resolve_after</code> duration, the issuing EMS event expires.</li>
<li><code>resolve_key</code> (optional) bookend key used to match bookend EMS events. Defaults to prefixed (<code>^^</code>) labels
  in <code>exports</code> section. <code>resolve_key</code> allows you to override what is defined in the <code>exports</code> section.</li>
</ul>
</li>
</ul>
<p>Labels are only exported if they are included in the <code>exports</code> section.</p>
<p>Example template definition for the <code>LUN.offline</code> EMS event:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LUN.offline</span><span class="w"></span>
<span class="w">    </span><span class="nt">matches</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">volume_name</span><span class="w"></span>
<span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">abc_vol</span><span class="w"></span>
<span class="w">    </span><span class="nt">exports</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^^parameters.object_uuid            =&gt; object_uuid</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parameters.object_type              =&gt; object_type</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parameters.lun_path                 =&gt; lun_path</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parameters.volume_name              =&gt; volume</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parameters.volume_dsid              =&gt; volume_ds_id</span><span class="w"></span>
<span class="w">    </span><span class="nt">resolve_when_ems</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LUN.online</span><span class="w"></span>
<span class="w">        </span><span class="nt">resolve_after</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">672h</span><span class="w"></span>
<span class="w">        </span><span class="nt">resolve_key</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^^parameters.object_uuid        =&gt; object_uuid</span><span class="w"></span>
</code></pre></div>
<h3 id="how-do-i-find-the-full-list-of-supported-ems-events">How do I find the full list of supported EMS events?<a class="headerlink" href="#how-do-i-find-the-full-list-of-supported-ems-events" title="Permanent link">&para;</a></h3>
<p>ONTAP documents the list of EMS events created in
the <a href="https://mysupport.netapp.com/documentation/productlibrary/index.html?productID=62286">ONTAP EMS Event Catalog</a>.</p>
<p>You can also query a live system and ask the cluster for its event catalog like so:</p>
<div class="highlight"><pre><span></span><code>curl --insecure --user &quot;user:password&quot; &#39;https://10.61.124.110/api/support/ems/messages?fields=*&#39;
</code></pre></div>
<p>Example Output</p>
<div class="highlight"><pre><span></span><code>{
  &quot;records&quot;: [
    {
      &quot;name&quot;: &quot;AccessCache.NearLimits&quot;,
      &quot;severity&quot;: &quot;alert&quot;,
      &quot;description&quot;: &quot;This message occurs when the access cache module is near its limits for entries or export rules. Reaching these limits can prevent new clients from being able to mount and perform I/O on the storage system, and can also cause clients to be granted or denied access based on stale cached information.&quot;,
      &quot;corrective_action&quot;: &quot;Ensure that the number of clients accessing the storage system continues to be below the limits for access cache entries and export rules across those entries. If the set of clients accessing the storage system is constantly changing, consider using the \&quot;vserver export-policy access-cache config modify\&quot; command to reduce the harvest timeout parameter so that cache entries for clients that are no longer accessing the storage system can be evicted sooner.&quot;,
      &quot;snmp_trap_type&quot;: &quot;severity_based&quot;,
      &quot;deprecated&quot;: false
    },
...
    {
      &quot;name&quot;: &quot;ztl.smap.online.status&quot;,
      &quot;severity&quot;: &quot;notice&quot;,
      &quot;description&quot;: &quot;This message occurs when the specified partition on a Software Defined Flash drive could not be onlined due to internal S/W or device error.&quot;,
      &quot;corrective_action&quot;: &quot;NONE&quot;,
      &quot;snmp_trap_type&quot;: &quot;severity_based&quot;,
      &quot;deprecated&quot;: false
    }
  ],
  &quot;num_records&quot;: 7273
}
</code></pre></div>
<h2 id="ems-prometheus-alerts">Ems Prometheus Alerts<a class="headerlink" href="#ems-prometheus-alerts" title="Permanent link">&para;</a></h2>
<p>Refer <a href="../prometheus-exporter/#prometheus-alerts">Prometheus-Alerts</a></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; NetApp</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
