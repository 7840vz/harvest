<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>ONTAP cDOT - Harvest</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Harvest</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">What is Harvest?</a>
                            </li>
                            <li class="navitem">
                                <a href="../quickstart/" class="nav-link">Quickstart</a>
                            </li>
                            <li class="navitem">
                                <a href="../install/" class="nav-link">Installation</a>
                            </li>
                            <li class="navitem">
                                <a href="../system-requirements/" class="nav-link">System Requirements</a>
                            </li>
                            <li class="navitem">
                                <a href="../upgrade/" class="nav-link">Upgrade</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Prepare Monitored Clusters <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">ONTAP cDOT</a>
</li>
                                    
<li>
    <a href="../prepare-7mode-clusters/" class="dropdown-item">ONTAP 7mode</a>
</li>
                                    
<li>
    <a href="../prepare-storagegrid-clusters/" class="dropdown-item">StorageGRID</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../configure-harvest-basic/" class="nav-link">Configure Harvest (basic)</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Configure Exporters <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../prometheus-exporter/" class="dropdown-item">Prometheus</a>
</li>
                                    
<li>
    <a href="../influxdb-exporter/" class="dropdown-item">InfluxDB</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../configure-grafana/" class="nav-link">Configure Grafana</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Configure Collectors <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../configure-zapi/" class="dropdown-item">ZAPI</a>
</li>
                                    
<li>
    <a href="../configure-rest/" class="dropdown-item">REST</a>
</li>
                                    
<li>
    <a href="../configure-ems/" class="dropdown-item">EMS</a>
</li>
                                    
<li>
    <a href="../configure-storagegrid/" class="dropdown-item">StorageGRID</a>
</li>
                                    
<li>
    <a href="../configure-unix/" class="dropdown-item">Unix</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../configure-templates/" class="nav-link">Templates</a>
                            </li>
                            <li class="navitem">
                                <a href="../dashboards/" class="nav-link">Dashboards</a>
                            </li>
                            <li class="navitem">
                                <a href="../manage-harvest/" class="nav-link">Manage Harvest Pollers</a>
                            </li>
                            <li class="navitem">
                                <a href="../configure-harvest-advanced/" class="nav-link">Configure Harvest (advanced)</a>
                            </li>
                            <li class="navitem">
                                <a href="../troubleshooting/" class="nav-link">Troubleshoot</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../resources/templates-and-metrics/" class="dropdown-item">Templates And Metrics</a>
</li>
                                    
<li>
    <a href="../resources/matrix/" class="dropdown-item">Matrix</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../license/" class="dropdown-item">License</a>
</li>
                                    
<li>
    <a href="../release-notes/" class="dropdown-item">Release Notes</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../upgrade/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../prepare-7mode-clusters/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/NetApp/harvest" class="nav-link">NetApp/harvest</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#prepare-ontap-cdot-cluster" class="nav-link">Prepare ONTAP cDOT cluster</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#creating-ontap-user" class="nav-link">Creating ONTAP user</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#using-certificate-authentication" class="nav-link">Using Certificate Authentication</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#create-self-signed-subject-alternate-name-certificates-for-ontap" class="nav-link">Create Self-Signed Subject Alternate Name Certificates for ONTAP</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#create-client-certificates-for-password-less-login" class="nav-link">Create Client Certificates for Password-less Login</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#install-client-certificates-on-cluster" class="nav-link">Install Client Certificates on Cluster</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#update-harvestyml-to-use-client-certificates" class="nav-link">Update Harvest.yml to use client certificates</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#reference" class="nav-link">Reference</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="prepare-ontap-cdot-cluster">Prepare ONTAP cDOT cluster<a class="headerlink" href="#prepare-ontap-cdot-cluster" title="Permanent link">&para;</a></h2>
<p>NetApp Harvest requires login credentials to access monitored hosts. Although, a generic admin account can be used, it
is best practice to create a dedicated monitoring account with the least privilege access.</p>
<p>In the examples below, the user, group, roles, etc., use a naming convention of ‘netapp-harvest’. These can be
modified as needed to match your environment standards.</p>
<p>There are few steps required to prepare each monitored system for collection.
Harvest supports two authentication styles (<code>auth_style</code>) to connect to ONTAP clusters.<br />
They are <code>basic_auth</code> or <code>certificate_auth</code>. Both work well, but if you're starting fresh, the recommendation is to
create a read-only harvest user on your ONTAP server and use certificate-based TLS authentication.</p>
<p>Here's a summary of what we're going to do</p>
<ol>
<li>Create an ONTAP role with the necessary capabilities that Harvest will use to auth and collect data</li>
<li>Create a user account using the role created in step #1.</li>
</ol>
<h2 id="creating-ontap-user">Creating ONTAP user<a class="headerlink" href="#creating-ontap-user" title="Permanent link">&para;</a></h2>
<p>There are two ways to create a read-only user:</p>
<ol>
<li>Create a user with read-only access to <strong>all</strong> API objects</li>
<li>Create a user with read-only access to only the APIs Harvest collects today</li>
</ol>
<p>The second option has a smaller attack surface, but each time you want to collect counters for a new object, you will
need to update the user's privileges.</p>
<p>Below we explain how to create an ONTAP user and role for Harvest using ONTAP System Manager (Classic interface &amp; New
interface) and CLI.</p>
<h3 id="system-manager-new-interface">System Manager: New interface<a class="headerlink" href="#system-manager-new-interface" title="Permanent link">&para;</a></h3>
<p><em>Note: in this section we add a user with read-only access to all API objects. For limited access, use either the
classic interface or the CLI</em></p>
<p>Open System Manager. Click on <em>CLUSTER</em> in the left menu bar, <em>Settings</em> and <em>Users and Roles</em>.</p>
<p><img alt="System Manager Settings" src="../assets/prepare-ontap/ontap_user_sm_0.png" /></p>
<p>In the right column, under <em>Roles</em>, click on <em>Add</em> to add a new role.</p>
<p><img alt="System Manager Settings" src="../assets/prepare-ontap/ontap_user_sm_1.png" /></p>
<p>Choose a role name (e.g. <em>harvest2-role</em>). In the <em>REST API PATH</em> field, type <em>/api</em> and select <em>Read-Only</em> for
<em>ACCESS</em>. Click on <em>Save</em>.</p>
<p><img alt="System Manager Settings" src="../assets/prepare-ontap/ontap_user_sm_2.png" /></p>
<p>In the left column, under <em>Users</em>, click on <em>Add</em> to create a new user. Choose a username. Under <em>Role</em>, select the role
that we just created. Under <em>User Login Methods</em> select <em>ONTAPI</em>, and select one of the two authentication methods. Type
in a password if you chose <em>Password</em>. Click on <em>Save</em></p>
<p><img alt="System Manager Settings" src="../assets/prepare-ontap/ontap_user_sm_3.png" /></p>
<p>If you chose <em>Password</em>, you can add the username and password to the Harvest configuration file and start Harvest. If
you chose <em>Certificate</em> jump to <a href="#using-certificate-authentication">Using Certificate Authentication</a> to generate
certificates files.</p>
<h3 id="system-manager-classic-interface">System Manager: Classic interface<a class="headerlink" href="#system-manager-classic-interface" title="Permanent link">&para;</a></h3>
<p>Open System Manager. Click on the Settings icon in the top-right corner of the window.</p>
<p><img alt="System Manager Classic Settings" src="../assets/prepare-ontap/ontap_user_smc_0.png" /></p>
<p>Click on <em>Roles</em> in the left menu bar and click <em>Add</em>. Choose a role name (e.g. <em>harvest2-role</em>).</p>
<p><img alt="System Manager Classic Settings" src="../assets/prepare-ontap/ontap_user_smc_1.png" /></p>
<p>If you want to give Harvest read-only access to <strong>all</strong> API objects, then under <em>Role Attributes</em> click on <em>Add</em>, under
<em>Command</em> type <em>DEFAULT</em>, leave <em>Query</em> empty, select <em>readonly</em> under <em>Access Level</em>, click on <em>OK</em> and <em>Add</em>.</p>
<p>If you want to limit the API objects, then under <em>Role Attributes</em>, add each of the following lines as an entry. All of
those should be entered under the <em>Command</em> column, <em>Query</em> should be left blank, and <em>Access Level</em> should be selected
<em>readonly</em>.</p>
<ul>
<li>cluster</li>
<li>lun</li>
<li>snapmirror</li>
<li>statistics</li>
<li>storage aggregate</li>
<li>storage disk</li>
<li>storage shelf</li>
<li>system node</li>
<li>version</li>
<li>volume</li>
</ul>
<p>After you click on <em>Add</em>, this is what you should see:</p>
<p><img alt="System Manager Classic Settings" src="../assets/prepare-ontap/ontap_user_smc_2.png" /></p>
<p>Now we need to create a user. Click on <em>Users</em> in the left menu bar and <em>Add</em>. Choose a username and password. Under
<em>User Login Methods</em>, click on <em>Add</em>, select <em>ontapi</em> as <em>Application</em> and select the role that we just created as
<em>Role</em>. Click on <em>Add</em> in the pop-up window to save.</p>
<p><img alt="System Manager Classic Settings" src="../assets/prepare-ontap/ontap_user_smc_3.png" /></p>
<p>Now add the username and password to <code>harvest.yml</code> and start Harvest.</p>
<h3 id="ontap-cli">ONTAP CLI<a class="headerlink" href="#ontap-cli" title="Permanent link">&para;</a></h3>
<p>We are going to:</p>
<ul>
<li>create a Harvest role with read-only access to the API objects</li>
<li>create a Harvest user and assign it to that role</li>
</ul>
<p>You should decide if you want to limit the Harvest role to only the subset of API objects Harvest requires or
give Harvest access to all API objects. In both cases, Harvest's access will be read-only.</p>
<p>Either approach is fine, following the principle of least-privilege, we recommend the limited approach.</p>
<p>Login to the CLI of your c-DOT ONTAP system using SSH.</p>
<h4 id="least-privilege-approach">Least-privilege approach<a class="headerlink" href="#least-privilege-approach" title="Permanent link">&para;</a></h4>
<p>Verify there are no errors when you copy/paste these. Warnings are fine.</p>
<div class="highlight"><pre><span></span><code>security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;cluster&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;lun&quot;</span>    
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;qos workload show&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;snapmirror&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;statistics&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;storage aggregate&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;storage disk&quot;</span>     
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;storage shelf&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;system health status show&quot;</span> 
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;system health subsystem show&quot;</span>  
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;system node&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;version&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;volume&quot;</span>

<span class="c1"># Permissions required for Harvest 22.05+ security dashboard</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;network interface&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;security&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;storage encryption disk&quot;</span>
security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;vserver&quot;</span>
</code></pre></div>
<h4 id="all-apis-read-only-approach">All APIs read-only approach<a class="headerlink" href="#all-apis-read-only-approach" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>security login role create -role harvest2-role -access <span class="nb">readonly</span> -cmddirname <span class="s2">&quot;DEFAULT&quot;</span>
</code></pre></div>
<h4 id="create-harvest-user-and-associate-to-role">Create harvest user and associate to role<a class="headerlink" href="#create-harvest-user-and-associate-to-role" title="Permanent link">&para;</a></h4>
<p>Use this for password authentication</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ZAPI based access</span>
security login create -user-or-group-name harvest2 -application ontapi -role harvest2-role -authentication-method password

<span class="c1"># REST based access</span>
security login create -user-or-group-name harvest2 -application http -role harvest2-role -authentication-method password   
</code></pre></div>
<p>Or this for certificate authentication</p>
<div class="highlight"><pre><span></span><code>security login create -user-or-group-name harvest2 -application ontapi <span class="se">\</span>
 -role harvest2-role -authentication-method cert
</code></pre></div>
<h4 id="7-mode-cli">7-Mode CLI<a class="headerlink" href="#7-mode-cli" title="Permanent link">&para;</a></h4>
<p>Login to the CLI of your 7-Mode ONTAP system (e.g. using SSH). First, we create a user role. If you want to give the
user readonly access to <strong>all</strong> API objects, type in the following command:</p>
<div class="highlight"><pre><span></span><code>useradmin role modify harvest2-role -a login-http-admin,api-system-get-version, <span class="se">\</span>
api-system-get-info,api-perf-object-*,api-ems-autosupport-log,api-diagnosis-status-get, <span class="se">\</span>
api-lun-list-info,api-diagnosis-subsystem-config-get-iter,api-disk-list-info, <span class="se">\</span>
api-diagnosis-config-get-iter,api-aggr-list-info,api-volume-list-info, <span class="se">\</span>
api-storage-shelf-environment-list-info,api-qtree-list,api-quota-report
</code></pre></div>
<h1 id="using-certificate-authentication">Using Certificate Authentication<a class="headerlink" href="#using-certificate-authentication" title="Permanent link">&para;</a></h1>
<p>See <a href="https://github.com/NetApp/harvest/issues/314#issuecomment-882120238">comments here for troubleshooting</a> client
certificate authentication.</p>
<p>Client certificate authentication allows you to authenticate with your ONTAP cluster without including
username/passwords in your <code>harvest.yml</code> file. The process to setup client certificates is straightforward, although
self-signed certificates introduce more work as does Go's strict treatment of common names.</p>
<p>Unless you've installed production certificates on your ONTAP cluster, you'll need to replace your cluster's
common-name-based self-signed certificates with a subject alternative name based certificate. After that step is
completed, we'll create client certificates and add those for passwordless login.</p>
<p>If you can't or don't want to replace your ONTAP cluster certificates, there are some workarounds. You can</p>
<ul>
<li>Use <code>use_insecure_tls: true</code> in your <code>harvest.yml</code> to disable certificate verification</li>
<li>Change your <code>harvest.yml</code> to connect via hostname instead of IP address</li>
</ul>
<h2 id="create-self-signed-subject-alternate-name-certificates-for-ontap">Create Self-Signed Subject Alternate Name Certificates for ONTAP<a class="headerlink" href="#create-self-signed-subject-alternate-name-certificates-for-ontap" title="Permanent link">&para;</a></h2>
<p>Subject alternate name (SAN) certificates allow multiple hostnames in a single certificate. Starting with Go 1.3, when
connecting to a cluster via its IP address, the CN field in the server certificate is ignored. This often causes errors
like this:
<code>x509: cannot validate certificate for 127.0.0.1 because it doesn't contain any IP SANs</code></p>
<h3 id="overview-of-steps-to-create-a-self-signed-san-certificate-and-make-ontap-use-it">Overview of steps to create a self-signed SAN certificate and make ONTAP use it<a class="headerlink" href="#overview-of-steps-to-create-a-self-signed-san-certificate-and-make-ontap-use-it" title="Permanent link">&para;</a></h3>
<ol>
<li>Create a root key</li>
<li>Create a root certificate authority certificate</li>
<li>Create a SAN certificate for your ONTAP cluster, using #2 to create it</li>
<li>Install root ca certificate created in step #2 on cluster</li>
<li>Install SAN certificate created in step #3 on your cluster</li>
<li>Modify you cluster/SVM to use the new certificate installed at step #5</li>
</ol>
<h4 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># create a place to store the certificate authority files, adjust as needed
mkdir -p ca/{private,certs}
</code></pre></div>
<h4 id="create-a-root-key">Create a root key<a class="headerlink" href="#create-a-root-key" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>cd ca
# generate a private key that we will use to create our self-signed certificate authority
openssl genrsa -out private/ca.key.pem 4096
chmod 400 private/ca.key.pem
</code></pre></div>
<h4 id="create-a-root-certificate-authority-certificate">Create a root certificate authority certificate<a class="headerlink" href="#create-a-root-certificate-authority-certificate" title="Permanent link">&para;</a></h4>
<p>Download the sample [samples/openssl.cnf] file and put it in the directory we created in <a href="#setup">setup</a>. Edit line 9,
changing <code>dir</code> to point to your <code>ca</code> directory created in <a href="#setup">setup</a>.</p>
<div class="highlight"><pre><span></span><code>openssl req -config openssl.cnf -key private/ca.key.pem -new -x509 -days 7300 -sha256 -extensions v3_ca -out certs/ca.cert.pem

# Verify
openssl x509 -noout -text -in certs/ca.cert.pem

# Make sure these are present
    Signature Algorithm: sha256WithRSAEncryption               &lt;======== Signature Algorithm can not be sha-1
        X509v3 extensions:
            X509v3 Subject Key Identifier: 
                --removed
            X509v3 Authority Key Identifier: 
                --removed

            X509v3 Basic Constraints: critical
                CA:TRUE                                        &lt;======== CA must be true
            X509v3 Key Usage: critical
                Digital Signature, Certificate Sign, CRL Sign  &lt;======== Digital and certificate signature
</code></pre></div>
<h4 id="create-a-san-certificate-for-your-ontap-cluster">Create a SAN certificate for your ONTAP cluster<a class="headerlink" href="#create-a-san-certificate-for-your-ontap-cluster" title="Permanent link">&para;</a></h4>
<p>First, we'll create the certificate signing request and then the certificate. In this example, the ONTAP cluster is
named <code>umeng-aff300-05-06</code>, update accordingly.</p>
<p>Download the sample [samples/server_cert.cnf] file and put it in the directory we created in <a href="#setup">setup</a>. Edit lines
18-21 to include your ONTAP cluster hostnames and IP addresses. Edit lines 6-11 with new names as needed.</p>
<div class="highlight"><pre><span></span><code>openssl req -new -newkey rsa:4096 -nodes -sha256 -subj &quot;/&quot; -config server_cert.cnf -outform pem -out umeng-aff300-05-06.csr -keyout umeng-aff300-05-06.key

# Verify
openssl req -text -noout -in umeng-aff300-05-06.csr

# Make sure these are present
        Attributes:
        Requested Extensions:
            X509v3 Subject Alternative Name:         &lt;======== Section that lists alternate DNS and IP names
                DNS:umeng-aff300-05-06-cm.rtp.openenglab.netapp.com, DNS:umeng-aff300-05-06, IP Address:10.193.48.11, IP Address:10.193.48.11
    Signature Algorithm: sha256WithRSAEncryption     &lt;======== Signature Algorithm can not be sha-1
</code></pre></div>
<p>We'll now use the certificate signing request and the recently create certificate authority to create a new SAN
certificate for our cluster.</p>
<div class="highlight"><pre><span></span><code>openssl x509 -req -sha256 -days 30 -in umeng-aff300-05-06.csr -CA certs/ca.cert.pem -CAkey private/ca.key.pem -CAcreateserial -out umeng-aff300-05-06.crt -extensions req_ext -extfile server_cert.cnf

# Verify
openssl x509 -text -noout -in umeng-aff300-05-06.crt

# Make sure these are present
X509v3 extensions:
            X509v3 Subject Alternative Name:       &lt;======== Section that lists alternate DNS and IP names
                DNS:umeng-aff300-05-06-cm.rtp.openenglab.netapp.com, DNS:umeng-aff300-05-06, IP Address:10.193.48.11, IP Address:10.193.48.11
    Signature Algorithm: sha256WithRSAEncryption   &lt;======== Signature Algorithm can not be sha-1
</code></pre></div>
<h4 id="install-root-ca-certificate-on-cluster">Install Root CA Certificate On Cluster<a class="headerlink" href="#install-root-ca-certificate-on-cluster" title="Permanent link">&para;</a></h4>
<p>Login to your cluster with admin credentials and install the server certificate authority.</p>
<div class="highlight"><pre><span></span><code>ssh admin@IP
umeng-aff300-05-06::*&gt; security certificate install -type server-ca

Please enter Certificate: Press &lt;Enter&gt; when done
-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----

You should keep a copy of the CA-signed digital certificate for future reference.

The installed certificate&#39;s CA and serial number for reference:
CA: ntap
Serial: 46AFFC7A3A9999999E8FB2FEB0

The certificate&#39;s generated name for reference: ntap
</code></pre></div>
<p>Now install the server certificate we created above with SAN.</p>
<div class="highlight"><pre><span></span><code>umeng-aff300-05-06::*&gt; security certificate install -type server

Please enter Certificate: Press &lt;Enter&gt; when done
-----BEGIN CERTIFICATE-----
..
-----END CERTIFICATE-----

Please enter Private Key: Press &lt;Enter&gt; when done
-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----

Please enter certificates of Certification Authorities (CA) which form the certificate chain of the server certificate. This starts with the issuing CA certificate of the server certificate and can range up to the root CA certificate.

Do you want to continue entering root and/or intermediate certificates {y|n}: n
</code></pre></div>
<p>If ONTAP tells you the provided certificate does not have a common name in the subject field, type the hostname of the
cluster like this:</p>
<div class="highlight"><pre><span></span><code>The provided certificate does not have a common name in the subject field.

Enter a valid common name to continue installation of the certificate:

Enter a valid common name to continue installation of the certificate: umeng-aff300-05-06-cm.rtp.openenglab.netapp.com

You should keep a copy of the private key and the CA-signed digital certificate for future reference.

The installed certificate&#39;s CA and serial number for reference:
CA: ntap
Serial: 67A94AA25B229A68AC5BABACA8939A835AA998A58

The certificate&#39;s generated name for reference: umeng-aff300-05-06-cm.rtp.openenglab.netapp.com
</code></pre></div>
<h4 id="modify-the-admin-svm-to-use-the-new-certificate">Modify the admin SVM to use the new certificate<a class="headerlink" href="#modify-the-admin-svm-to-use-the-new-certificate" title="Permanent link">&para;</a></h4>
<p>We'll modify the cluster's admin SVM to use the just installed server certificate and certificate authority.</p>
<div class="highlight"><pre><span></span><code>vserver show -type admin -fields vserver,type
vserver            type
------------------ -----
umeng-aff300-05-06 admin

umeng-aff300-05-06::*&gt; ssl modify -vserver umeng-aff300-05-06 -server-enabled true -serial 67A94AA25B229A68AC5BABACA8939A835AA998A58 -ca ntap
  (security ssl modify)
</code></pre></div>
<p>You can verify the certificate(s) are installed and working by using <code>openssl</code> like so:</p>
<div class="highlight"><pre><span></span><code>openssl s_client -CAfile certs/ca.cert.pem -showcerts -servername server -connect umeng-aff300-05-06-cm.rtp.openenglab.netapp.com:443

CONNECTED(00000005)
depth=1 C = US, ST = NC, L = RTP, O = ntap, OU = ntap
verify return:1
depth=0 
verify return:1
...
</code></pre></div>
<p>without the <code>-CAfile</code>, <code>openssl</code> will report</p>
<div class="highlight"><pre><span></span><code>CONNECTED(00000005)
depth=0 
verify error:num=20:unable to get local issuer certificate
verify return:1
depth=0 
verify error:num=21:unable to verify the first certificate
verify return:1
---
</code></pre></div>
<h2 id="create-client-certificates-for-password-less-login">Create Client Certificates for Password-less Login<a class="headerlink" href="#create-client-certificates-for-password-less-login" title="Permanent link">&para;</a></h2>
<p>Copy the server certificate we created above into the Harvest install directory.</p>
<div class="highlight"><pre><span></span><code>cp ca/umeng-aff300-05-06.crt /opt/harvest
cd /opt/harvest
</code></pre></div>
<p>Create a self-signed client key and certificate with the same name as the hostname where Harvest is running. It's not
required to name the key/cert pair after the hostname, but if you do, Harvest will load them automatically when you
specify <code>auth_style: certificate_auth</code> otherwise you can point to them directly.
See <a href="https://github.com/NetApp/harvest#pollers">Pollers</a> for details.</p>
<p>Change the common name to the ONTAP user you setup with the harvest role above. e.g <code>harvest2</code></p>
<div class="highlight"><pre><span></span><code>cd /opt/harvest
mkdir cert
openssl req -x509 -nodes -days 1095 -newkey rsa:2048 -keyout cert/$(hostname).key -out cert/$(hostname).pem -subj &quot;/CN=harvest2&quot;
</code></pre></div>
<h2 id="install-client-certificates-on-cluster">Install Client Certificates on Cluster<a class="headerlink" href="#install-client-certificates-on-cluster" title="Permanent link">&para;</a></h2>
<p>Login to your cluster with admin credentials and install the client certificate.</p>
<div class="highlight"><pre><span></span><code>ssh admin@IP
umeng-aff300-05-06::*&gt;  security certificate install -type client-ca -vserver umeng-aff300-05-06

Please enter Certificate: Press &lt;Enter&gt; when done
-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----

You should keep a copy of the CA-signed digital certificate for future reference.

The installed certificate&#39;s CA and serial number for reference:
CA: cbg
Serial: B77B59444444CCCC

The certificate&#39;s generated name for reference: cbg_B77B59444444CCCC
</code></pre></div>
<p>Now that the client certificate is installed, let's enable it.</p>
<div class="highlight"><pre><span></span><code>umeng-aff300-05-06::*&gt; ssl modify -vserver umeng-aff300-05-06 -client-enabled true
  (security ssl modify)
</code></pre></div>
<p>Verify with a recent version of <code>curl</code>. If you are runnin on a Mac <a href="">see below</a>.</p>
<div class="highlight"><pre><span></span><code>curl --cacert umeng-aff300-05-06.crt --key cert/$(hostname).key --cert cert/$(hostname).pem https://umeng-aff300-05-06-cm.rtp.openenglab.netapp.com/api/storage/disks
</code></pre></div>
<h2 id="update-harvestyml-to-use-client-certificates">Update Harvest.yml to use client certificates<a class="headerlink" href="#update-harvestyml-to-use-client-certificates" title="Permanent link">&para;</a></h2>
<p>Update the poller section with <code>auth_style: certificate_auth</code> like this:</p>
<div class="highlight"><pre><span></span><code>  u2-cert: 
    auth_style: certificate_auth
    addr: umeng-aff300-05-06-cm.rtp.openenglab.netapp.com
</code></pre></div>
<p>Restart your poller and enjoy your password-less life-style.</p>
<h3 id="macos">macOS<a class="headerlink" href="#macos" title="Permanent link">&para;</a></h3>
<p>The version of <code>curl</code> installed on macOS up through Monterey is not recent enough to work with self-signed SAN certs.
You will need to install a newer version of <code>curl</code> via Homebrew, MacPorts, source, etc.</p>
<p>Example of failure when running with older version of <code>curl</code> - you will see this
in <a href="#install-client-certificates-on-cluster">client auth</a> test step above.</p>
<div class="highlight"><pre><span></span><code>curl --version
curl 7.64.1 (x86_64-apple-darwin20.0) libcurl/7.64.1 (SecureTransport) LibreSSL/2.8.3 zlib/1.2.11 nghttp2/1.41.0

curl --cacert umeng-aff300-05-06.crt --key cert/cgrindst-mac-0.key --cert cert/cgrindst-mac-0.pem https://umeng-aff300-05-06-cm.rtp.openenglab.netapp.com/api/storage/disks

curl: (60) SSL certificate problem: unable to get local issuer certificate
</code></pre></div>
<p>Let's install <code>curl</code> via Homebrew. Make sure you don't miss the message that Homebrew prints about your path.</p>
<div class="highlight"><pre><span></span><code>If you need to have curl first in your PATH, run:
  echo &#39;export PATH=&quot;/usr/local/opt/curl/bin:$PATH&quot;&#39; &gt;&gt; /Users/cgrindst/.bash_profile
</code></pre></div>
<p>Now when we make a client auth request with our self-signed certificate it works! <code>\o/</code></p>
<div class="highlight"><pre><span></span><code>brew install curl

curl --version
curl 7.80.0 (x86_64-apple-darwin20.6.0) libcurl/7.80.0 (SecureTransport) OpenSSL/1.1.1l zlib/1.2.11 brotli/1.0.9 zstd/1.5.0 libidn2/2.3.2 libssh2/1.10.0 nghttp2/1.46.0 librtmp/2.3 OpenLDAP/2.6.0
Release-Date: 2021-11-10
Protocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp 
Features: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz MultiSSL NTLM NTLM_WB SPNEGO SSL TLS-SRP UnixSockets zstd

curl --cacert umeng-aff300-05-06.crt --key cert/cgrindst-mac-0.key --cert cert/cgrindst-mac-0.pem https://umeng-aff300-05-06-cm.rtp.openenglab.netapp.com/api/storage/disks

{
  &quot;records&quot;: [
    {
      &quot;name&quot;: &quot;1.1.22&quot;,
      &quot;_links&quot;: {
        &quot;self&quot;: {
          &quot;href&quot;: &quot;/api/storage/disks/1.1.22&quot;
        }
      }
    }
}
</code></pre></div>
<hr />
<p>Change directory to your Harvest home directory (replace <code>/opt/harvest/</code> if this is not the default):</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">cd</span> /opt/harvest/
</code></pre></div>
<p>Generate an SSL cert and key pair with the following command. Note that it's preferred to generate these files using the
hostname of the local machine. The command below assumes <code>debian8</code> as our hostname name and <code>harvest2</code> as the user we
created in the previous step:</p>
<div class="highlight"><pre><span></span><code>openssl req -x509 -nodes -days <span class="m">1095</span> -newkey rsa:2048 -keyout cert/debian8.key <span class="se">\</span>
 -out cert/debian8.pem  -subj <span class="s2">&quot;/CN=harvest2&quot;</span>
</code></pre></div>
<p>Next, open the public key (<code>debian8.pem</code> in our example) and copy all of its content. Login into your ONTAP CLI and run
this command by replacing <strong>CLUSTER</strong> with the name of your cluster.</p>
<div class="highlight"><pre><span></span><code>security certificate install -type client-ca -vserver CLUSTER
</code></pre></div>
<p>Paste the public key content and hit enter. Output should be similar to this:</p>
<div class="highlight"><pre><span></span><code>jamaica::&gt; security certificate install -type client-ca -vserver jamaica 

Please enter Certificate: Press &lt;Enter&gt; when <span class="k">done</span>
-----BEGIN CERTIFICATE-----                       
MIIDETCCAfmgAwIBAgIUP9EUXyl2BDSUOkNEcDU0yqbJ29IwDQYJKoZIhvcNAQEL
BQAwGDEWMBQGA1UEAwwNaGFydmVzdDItY2xpMzAeFw0yMDEwMDkxMjA0MDhaFw0y
MzEwMDktcGFueSBMdGQxFzAVBgNVBAMlc3QyLWNsaTMwggEiMA0tcGFueSBGCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQCVVy25BeCRoGCJWFOlyUL7Ddkze4Hl2/6u
qye/3mk5vBNsGuXUrtad5XfBB70Ez9hWl5sraLiY68ro6MyX1icjiUTeaYDvS/76
Iw7HeXJ5Pyb/fWth1nePunytoLyG/vaTCySINkIV5nlxC+k0X3wWFJdfJzhloPtt
1Vdm7aCF2q6a2oZRnUEBGQb6t5KyF0/Xh65mvfgB0pl/AS2HY5Gz+~L54Xyvs+BY
V7UmTop7WBYl0L3QXLieERpHXnyOXmtwlm1vG5g4n/0DVBNTBXjEdvc6oRh8sxBN
ZlQWRApE7pa/I1bLD7G2AiS4UcPmR4cEpPRVEsOFOaAN3Z3YskvnAgMBAAGjUzBR
MB0GA1UdDgQWBBQr4syV6TCcgO/5EcU/F8L2YYF15jAfBgNVHSMEGDAWgBQr4syV
6TCcgO/5EcU/F8L2YYF15jAPBgNVHRMdfdfwerH/MA0GCSqGSIb^ECd3DQEBCwUA
A4IBAQBjP1BVhClRKkO/M3zlWa2L9Ztce6SuGwSnm6Ebmbs+iMc7o2N9p3RmV6Xl
h6NcdXRzzPAVrUoK8ewhnBzdghgIPoCI6inAf1CUhcCX2xcnE/osO+CfvKuFnPYE
WQ7UNLsdfka0a9kTK13r3GMs09z/VsDs0gD8UhPjoeO7LQhdU9tJ/qOaSP3s48pv
sYzZurHUgKmVOaOE4t9DAdevSECEWCETRETA<span class="nv">$Vbn</span>%@@@%%rcdrctru65ryFaByb+
hTtGhDnoHwzt/cAGvLGV/RyWdGFAbu7Fb1rV94ceggE7nh1FqbdLH9siot6LlnQN
MhEWp5PYgndOW49dDYUxoauCCkiA
-----END CERTIFICATE-----


You should keep a copy of the CA-signed digital certificate <span class="k">for</span> future reference.

The installed certificate<span class="s1">&#39;s CA and serial number for reference:</span>
<span class="s1">CA: harvest2</span>
<span class="s1">Serial: 3FD1145F2976043012213d3009095534CCRDBD2</span>

<span class="s1">The certificate&#39;</span>s generated name <span class="k">for</span> reference: harvest2
</code></pre></div>
<p>Finally, we need to enable SSL authentication with the following command (replace <strong>CLUSTER</strong> with the name of your
cluster):</p>
<div class="highlight"><pre><span></span><code>security ssl modify -client-enabled <span class="nb">true</span> -vserver CLUSTER
</code></pre></div>
<h2 id="reference">Reference<a class="headerlink" href="#reference" title="Permanent link">&para;</a></h2>
<ul>
<li>https://github.com/jcbsmpsn/golang-https-example</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; NetApp</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
